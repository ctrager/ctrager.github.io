<!DOCTYPE html>
<html>

<head>
    <meta name="Description" content="Video motion detection written by Corey Trager in HTML and Javascript">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Motion Detector</title>
    <style>
        body {
            font-family: verdana, arial;
            font-size: 16px;
            margin: 20px;
        }

        #live_motion_canvas {
            border: 1px solid black;
            background-color: green;
        }

        video {
            border: 1px solid black;
            background-color: lightgray;
        }

        #best_canvas {
            border: 1px solid black;
            background-color: lightgreen
        }

        #config {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid gray;
            width: 900px;
        }

        #config div {

            margin: 10px;
        }

        #show_config {
            display: none;
            margin-top: 20px;
            margin-bottom: 20px;

        }
    </style>
    <script>
        var first_time = true
        var first_capture = true
        var ready = false
        var video_stream
        var capture_canvas_el
        var best_canvas_el
        var diff_canvas_el
        var small_green_canvas
        var live_motion_canvas
        var video_el
        var image_el
        var content_div
        var score_el
        var capture_context
        var diff_context
        var small_green_context
        var live_motion_context
        var best_context

        var config = {
            width: 400,
            height: 200,
            downscale_factor: .25,
            rgb_threshold: 70,
            pct_of_pixels_threshold: 10,
            diff_interval_in_milliseconds: 200,
            best_moment_interval_in_milliseconds: 10 * 1000
        }

        function init_video() {

            navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        width: config.width,
                        height: config.height
                    }
                })
                .then(function (stream) {
                    video_stream = stream
                    video_el.srcObject = stream
                    ready = true
                    console.log("ready")
                })
                .catch(function (err) {
                    console.log(err)
                })
        }

        function on_load() {
            console.log("on load")

            config.downscale_width = Math.round(config.width * config.downscale_factor)
            config.downscale_height = Math.round(config.height * config.downscale_factor)

            video_el = document.getElementById("video_el")
            video_el.width = config.width
            video_el.height = config.height
            video_el.autoplay = true

            score_el = document.getElementById("score_el")

            capture_canvas_el = document.createElement("canvas")
            capture_canvas_el.width = config.width
            capture_canvas_el.height = config.height

            best_canvas_el = document.getElementById("best_canvas")
            best_canvas_el.width = config.width
            best_canvas_el.height = config.height

            diff_canvas_el = document.createElement("canvas")
            diff_canvas_el.width = config.downscale_width
            diff_canvas_el.height = config.downscale_height

            small_green_canvas = document.createElement("canvas")
            small_green_canvas.width = config.downscale_width
            small_green_canvas.height = config.downscale_height

            live_motion_canvas = document.getElementById("live_motion_canvas")
            live_motion_canvas.width = config.width
            live_motion_canvas.height = config.height

            capture_context = capture_canvas_el.getContext("2d");
            best_context = best_canvas_el.getContext("2d");
            diff_context = diff_canvas_el.getContext("2d");
            small_green_context = small_green_canvas.getContext("2d");
            live_motion_context = live_motion_canvas.getContext("2d");

            // calc how many pixels must be "on" for there to be motion as a percentage of the pixels
            image_score_threshold = (config.downscale_width * config.downscale_height) * (config
                .pct_of_pixels_threshold * .01)


        }

        function on_change_config() {

        }

        function on_show_config() {
            document.getElementById("show_config").style = "display: none;"
            document.getElementById("config").style = "display:block;"

        }

        function on_hide_config() {
            document.getElementById("config").style = "display:none;"
            document.getElementById("show_config").style = "display: block;"
        }

        var diff_interval
        var best_moment_interval

        function on_start() {
            if (first_time) {
                first_time = false
                init_video()
            }

            detect_motion()
        }


        function detect_motion() {
            
            diff_interval = setInterval(diff_snapshot, config.diff_interval_in_milliseconds)
            best_moment_interval = setInterval(process_best_moment, config.best_moment_interval_in_milliseconds)
            on_hide_config()
        }

        var best_image_score = 0
        var best_image_data
        var image_score_threshold

        function process_best_moment() {
            if (!ready) return;

            if (best_image_score > 0) {
                best_context.putImageData(best_image_data, 0, 0)
                best_image_score = 0
            }
        }


        function diff_snapshot() {
            if (!ready) return;

            if (first_capture) {
                first_capture = false
                // capture an image, full size
                capture_context.drawImage(video_el, 0, 0, config.width, config.height);
                return
            }

            // put previous image on diff canvas, scaled down
            diff_context.globalCompositeOperation = 'source-over';
            diff_context.drawImage(capture_canvas_el, 0, 0, config.downscale_width, config.downscale_height)

            // capture an image, full size
            capture_context.drawImage(video_el, 0, 0, config.width, config.height);

            // put new image on diff canvas, scaled down, where only different pixes are lit up 
            diff_context.globalCompositeOperation = 'difference';
            diff_context.drawImage(capture_canvas_el, 0, 0, config.downscale_width, config.downscale_height)

            // get the image showing the different pixels
            var image_data = diff_context.getImageData(0, 0, config.downscale_width, config.downscale_height)

            // calc the score of the diff 
            var image_score = 0

            for (var i = 0; i < image_data.data.length; i += 4) {
                var r = image_data.data[i]
                var g = image_data.data[i + 1]
                var b = image_data.data[i + 2]

                var rgb = r + g + b

                // is the combined rgb bright enough?
                if (rgb > config.rgb_threshold) {
                    image_score++
                }


                // is the image with the most motion?
                if (image_score > config.pct_of_pixels_threshold) {
                    if (image_score > best_image_score) {
                        best_image_score = image_score
                        best_image_data = capture_context.getImageData(0, 0, config.width, config.height)
                    }
                }


                // turn image green for fun, for display on the screen
                var tot = r + g + b
                if (tot > 255) tot = 255;
                image_data.data[i] = 0
                image_data.data[i + 1] = tot
                image_data.data[i + 2] = 0

            }

            // show the percent of pixels with "motion"
            score_el.innerText = Math.round(image_score * 100 / (config.downscale_height * config.downscale_width))
            score_el.innerText += "%"

            // put the green image to another canvas
            small_green_context.putImageData(image_data, 0, 0)

            // scale up the green image, for better viewing
            live_motion_context.drawImage(small_green_canvas, 0, 0, config.width, config.height)

        }
    </script>
</head>

<body onload="on_load()">

    <button id="start_button" onclick="on_start()">start</button>

    <div id="show_config">
        <a href="Javascript:on_show_config()">Show config</a>
    </div>

    <div id="config">
        <div><a href="Javascript:on_hide_config()">Hide config</a></div>

        <div>
            The logic compares the latest snapshot with the previous snapshot. It calculates what percentage of the
            pixels are different. If the percentage is above a threshold, then that is considered "motion".
        </div>
        <div>
            Snapshot interval in milliseconds (0-1000):
            <input onchange="on_change_config()" id="diff_interval_in_milliseconds_input" type="number" value="200"
                min="1" max="1000" size="4"></input>
        </div>
        <div>
            Pixel threshold - how different must a pixel be to be considered different? Total of "difference" r + g + b
            (1-255):
            <input onchange="on_change_config()" id="rgb_threshold_input" type="number" value="75" min="1"
                max="255"></input>
        </div>

        <div>
            Image threshold - percent of image that must be different from previous (1-99):
            <input onchange="on_change_config()" id="image_score_threshold_input" type="number" value="15" min="1"
                max="99"></input>

        </div>

        <div>
            Width (100-1000) and Height (100-1000) of raw image in pixels:
            <input onchange="on_change_config()" id="width_input" type="number" value="400" min="100"
                max="1000"></input>
            <input onchange="on_change_config()" id="height_input" type="number" value="200" min="100"
                max="1000"></input>
        </div>


        <div>
            Downscale full image for pixel analysis by this factor. Bigger is slower. (.1 to 1.0):
            <input onchange="on_change_config()" id="downscale_factor_input" type="number" value=".25" min=".1"
                max="1.0"></input>
        </div>

    </div>
    <div>
        Live Video:
        <br>
        <video id="video_el"></video>

    </div>

    <div>
        Motion <span id="score_el">0%</span>
        <br>
        <canvas id="live_motion_canvas"></canvas>
    </div>

    <div>
        Snapshot of motion
        <br>
        <canvas id="best_canvas"></canvas>
    </div>
</body>

</html>