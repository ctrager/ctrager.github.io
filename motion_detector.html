<!DOCTYPE html>
<html>

<head>
    <meta name="Description" content="Video motion detection written by Corey Trager in HTML and Javascript">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Motion Detector</title>
    <style>
        canvas {
            border: 1px solid red;
        }

        video {
            border: 1px solid blue;
        }

        image {
            border: 1px solid orange;
        }
    </style>
    <script>
        var first_time = true
        var first_capture = true
        var ready = false
        var video_stream
        var capture_canvas_el
        var diff_canvas_el
        var diff_canvas_el2
        var diff_canvsa_el3
        var video_el
        var image_el
        var content_div
        var capture_context
        var diff_context
        var diff_context2
        var diff_context3

        var config = {
            width: 400,
            height: 200,
            downscale: .25
        }


        function init_video() {

            navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        width: config.width,
                        height: config.height
                    }
                })
                .then(function (stream) {
                    video_stream = stream
                    video_el.srcObject = stream
                    ready = true
                    console.log("ready")
                })
                .catch(function (err) {
                    console.log(err)
                })
        }

        function on_load() {
            console.log("on load")

            video_el = document.createElement("video")
            video_el.width = config.width
            video_el.height = config.height
            video_el.autoplay = true

            capture_canvas_el = document.createElement("canvas")
            capture_canvas_el.width = config.width
            capture_canvas_el.height = config.height

            diff_canvas_el = document.createElement("canvas")
            diff_canvas_el.width = config.width * config.downscale
            diff_canvas_el.height = config.height * config.downscale

            diff_canvas_el2 = document.createElement("canvas")
            diff_canvas_el2.width = config.width * config.downscale
            diff_canvas_el2.height = config.height * config.downscale

            diff_canvas_el3 = document.createElement("canvas")
            diff_canvas_el3.width = config.width 
            diff_canvas_el3.height = config.height 

            // image_el = document.createElement('img')
            // image_el.width = config.width



            // image_el.height = config.height

            document.getElementById("video_div").appendChild(video_el)
            document.getElementById("canvas_div").appendChild(capture_canvas_el)
            document.getElementById("canvas_div").appendChild(diff_canvas_el)
            document.getElementById("canvas_div").appendChild(diff_canvas_el2)
            document.getElementById("canvas_div2").appendChild(diff_canvas_el3)
      
            // document.getElementById("image_div").appendChild(image_el)

            capture_context = capture_canvas_el.getContext("2d");
            diff_context = diff_canvas_el.getContext("2d");
            diff_context2 = diff_canvas_el2.getContext("2d");
            diff_context3 = diff_canvas_el3.getContext("2d");

        }

        function on_start() {
            if (first_time) {
                first_time = false
                init_video()
            }
        }

        var prev_image_data

        function on_snapshot() {

            // put previous image on diff canvas, scaled down
            diff_context.globalCompositeOperation = 'source-over';
            diff_context.drawImage(capture_canvas_el, 0, 0, config.width * config.downscale, config.height * config.downscale)

            // capture an image, full size
            capture_context.drawImage(video_el, 0, 0, config.width, config.height);

            // put new image on diff canvas, scaled down, showing differences, 
            diff_context.globalCompositeOperation = 'difference';
            diff_context.drawImage(capture_canvas_el, 0, 0, config.width * config.downscale, config.height * config.downscale)

            // get the diffed image
            var image_data = diff_context.getImageData(0, 0, config.width * config.downscale, config.height * config.downscale)
            
            // turn the diff image green
            for (var i = 0; i < image_data.data.length; i += 4) {
                var r = image_data.data[i]
                var g = image_data.data[i + 1] 
                var b = image_data.data[i + 2]

                var tot = r + g + b
                if (tot > 255) tot = 255;
                image_data.data[i] = 0
                image_data.data[i+1] = tot
                image_data.data[i+2] = 0
                //image_data.data[i + 3] = 255
 
            }

            // put the green image to another canvas
            diff_context2.putImageData(image_data, 0, 0)
            
            //
            diff_context3.drawImage(diff_canvas_el2, 0, 0, config.width, config.height)

             if (first_capture) {
                first_capture = false
                return
            }
        }
    </script>
</head>

<body onload="on_load()">
    <button onclick="on_start()">start</button>
    <button onclick="on_snapshot()">snapshot</button>
    <div id="video_div"></div>
    <div id="canvas_div"></div>
    <div id="canvas_div2"></div>
    <!-- 
    <br>
    <video id="my_video" width="300" height="200" autoplay></video>
    <br>
    <canvas id="my_canvas" width="300" height="200"></canvas>
    <br>
    <image id="my_image" width="300" height="200"></image>
    -->
</body>

</html>