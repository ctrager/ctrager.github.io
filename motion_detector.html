<!DOCTYPE html>
<html>

<head>
    <meta name="Description" content="Video motion detection written by Corey Trager in HTML and Javascript">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Motion Detector</title>
    <style>
        body {
            font-family: verdana, arial;
            font-size: 16px;
            margin: 20px;
        }

        #live_motion_canvas {
            border: 1px solid black;
            background-color: green;
        }

        video {
            border: 1px solid black;
            background-color: lightgray;
        }

        #best_canvas {
            border: 1px solid black;
            background-color: black;
        }

        #config {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid gray;
            width: 900px;
        }

        #config div {

            margin: 10px;
        }

        #show_config {
            display: none;
            margin-top: 20px;
            margin-bottom: 20px;

        }
    </style>
    <script>
        var first_time = true
        var first_capture = true
        var ready = false
        var video_stream
        var capture_canvas_el
        var best_canvas_el
        var diff_canvas_el
        var small_green_canvas
        var live_motion_canvas
        var video_el
        var image_el
        var content_div
        var score_el
        var capture_context
        var diff_context
        var small_green_context
        var live_motion_context
        var best_context
        var start_time

        var config = {
            width: 400,
            height: 200,
            downscale_factor: .25,
            rgb_threshold: 70,
            pct_of_pixels_threshold: 10,
            diff_interval_in_milliseconds: 200,
            best_moment_interval_in_milliseconds: 10 * 1000,
            cycle: [5, 6, 8, 9]
        }

        var cycle_index = 0

        function init_video() {

            navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        width: config.width,
                        height: config.height
                    }
                })
                .then(function (stream) {
                    video_stream = stream
                    video_el.srcObject = stream
                    ready = true
                    detect_motion()
                })
                .catch(function (err) {
                    console.log(err)
                })
        }

        function on_load() {
            console.log("on load")

            config.downscale_width = Math.round(config.width * config.downscale_factor)
            config.downscale_height = Math.round(config.height * config.downscale_factor)

            video_el = document.getElementById("video_el")
            video_el.width = config.width
            video_el.height = config.height
            video_el.autoplay = true

            score_el = document.getElementById("score_el")

            capture_canvas_el = document.createElement("canvas")
            capture_canvas_el.width = config.width
            capture_canvas_el.height = config.height

            best_canvas_el = document.getElementById("best_canvas")
            best_canvas_el.width = config.width
            best_canvas_el.height = config.height

            diff_canvas_el = document.createElement("canvas")
            diff_canvas_el.width = config.downscale_width
            diff_canvas_el.height = config.downscale_height

            small_green_canvas = document.createElement("canvas")
            small_green_canvas.width = config.downscale_width
            small_green_canvas.height = config.downscale_height

            live_motion_canvas = document.getElementById("live_motion_canvas")
            live_motion_canvas.width = config.width
            live_motion_canvas.height = config.height

            capture_context = capture_canvas_el.getContext("2d");
            best_context = best_canvas_el.getContext("2d");
            diff_context = diff_canvas_el.getContext("2d");
            small_green_context = small_green_canvas.getContext("2d");
            live_motion_context = live_motion_canvas.getContext("2d");

        }

        function on_change_config() {

        }

        function on_show_config() {
            document.getElementById("show_config").style = "display: none;"
            document.getElementById("config").style = "display:block;"

        }

        function on_hide_config() {
            document.getElementById("config").style = "display:none;"
            document.getElementById("show_config").style = "display: block;"
        }

        var diff_interval
        var best_moment_interval

        function on_start() {
            if (first_time) {
                first_time = false
                init_video()
            }
        }


        function detect_motion() {

            diff_interval = setInterval(diff_snapshot, config.diff_interval_in_milliseconds)
            on_hide_config()
        }

        var best_image_pct = 0
        var best_image_data

        function process_best_moment() {
            console.log("process_best_moment", cycle_index, config.cycle[cycle_index], best_image_pct)

            if (best_image_pct > 0) {
                report(best_image_pct, best_image_data)
                best_image_pct = 0
            }

            if (cycle_index + 1 == config.cycle.length) {
                console.log("resetting")
                cycle_index = 0
            } else {
                setTimeout(process_best_moment, config.cycle[cycle_index] * 1000)
                cycle_index++
            }
        }

        function report(pct, image_data) {
            console.log(best_image_pct, new Date().getTime())
            best_context.putImageData(image_data, 0, 0)

            download_motion_image()
        }

        function download_motion_image() {
            console.log("download")
            var link = document.createElement('a');
            var filename = "pic_" + get_yyyy_mm_dd_hh_mm_ss(new Date()) + ".png"
            link.setAttribute("download", filename)
            link.href = best_canvas_el.toDataURL("image/png")
            link.innerText = "a link"
            document.body.appendChild(link);

            // wait for the link to be added to the document
            window.requestAnimationFrame(function () {
                // clicking link
                var event = new MouseEvent('click');
                link.dispatchEvent(event);
                document.body.removeChild(link);
            })
        }

        function get_yyyy_mm_dd_hh_mm_ss(dt) {
   
            // ensure date comes as 01, 09 etc
            var DD = ("0" + dt.getDate()).slice(-2);

            // getMonth returns month from 0
            var MM = ("0" + (dt.getMonth() + 1)).slice(-2);

            var YYYY = dt.getFullYear();

            var hh = ("0" + dt.getHours()).slice(-2);

            var mm = ("0" + dt.getMinutes()).slice(-2);

            var ss = ("0" + dt.getSeconds()).slice(-2);

            var date_string = YYYY + "-" + MM + "-" + DD + " " + hh + ":" + mm + ":" + ss;

            return date_string
        }

        function diff_snapshot() {
            if (!ready) return;

            if (first_capture) {
                first_capture = false
                // capture an image, full size
                capture_context.drawImage(video_el, 0, 0, config.width, config.height);
                return
            }

            // put previous image on diff canvas, scaled down
            diff_context.globalCompositeOperation = 'source-over';
            diff_context.drawImage(capture_canvas_el, 0, 0, config.downscale_width, config.downscale_height)

            // capture an image, full size
            capture_context.drawImage(video_el, 0, 0, config.width, config.height);

            // put new image on diff canvas, scaled down, where only different pixes are lit up 
            diff_context.globalCompositeOperation = 'difference';
            diff_context.drawImage(capture_canvas_el, 0, 0, config.downscale_width, config.downscale_height)

            // get the image showing the different pixels
            var image_data = diff_context.getImageData(0, 0, config.downscale_width, config.downscale_height)

            // calc the score of the diff 
            var pixel_count = 0

            for (var i = 0; i < image_data.data.length; i += 4) {
                var r = image_data.data[i]
                var g = image_data.data[i + 1]
                var b = image_data.data[i + 2]

                var rgb = r + g + b

                // is the combined rgb bright enough?
                if (rgb > config.rgb_threshold) {
                    pixel_count++
                }

                // turn image green for fun, for display on the screen
                var tot = r + g + b
                if (tot > 255) tot = 255;
                image_data.data[i] = 0
                image_data.data[i + 1] = tot
                image_data.data[i + 2] = 0

            }

            image_pct = Math.round(pixel_count * 100 / (config.downscale_height * config.downscale_width))

            // show the percent of pixels with "motion"
            score_el.innerText = image_pct + "%"

            // put the green image to another canvas
            small_green_context.putImageData(image_data, 0, 0)

            // scale up the green image, for better viewing
            live_motion_context.drawImage(small_green_canvas, 0, 0, config.width, config.height)

            // image_pct > 90, is like a glitch
            if (image_pct < 90 && image_pct > config.pct_of_pixels_threshold) {
                console.log("image within threshold", image_pct)
                var captured_motion_image_data = capture_context.getImageData(0, 0, config.width, config.height)
                if (cycle_index == 0) {
                    report(image_pct, captured_motion_image_data)
                    setTimeout(process_best_moment, config.cycle[0] * 1000)
                    cycle_index++
                } else {
                    if (image_pct > best_image_pct) {
                        best_image_pct = image_pct
                        best_image_data = captured_motion_image_data
                    }
                }
            }

        }
    </script>
</head>

<body onload="on_load()">

    <div id="first_div"></div>
    <button id="start_button" onclick="on_start()">start</button>

    <div id="show_config">
        <a href="Javascript:on_show_config()">Show config</a>
    </div>

    <div id="config">
        <div><a href="Javascript:on_hide_config()">Hide config</a></div>

        <div>
            The logic compares the latest snapshot with the previous snapshot. It calculates what percentage of the
            pixels are different. If the percentage is above a threshold, then that is considered "motion".
        </div>

        <div>
            Throttle reporting. After motion is first detected and reported, if there is still motion, keep reporting
            motion after these intervals (in seconds).
            For example, for "10 20 20 60 300 3600", report motion, then report again 10 seconds later, then 20 seconds
            after that,
            then 20 seconds after that, the 60 seconds after that, then 5 minutes after that, then one hour after that.
            Then return to initial state.
            <br>
            <input onchange="on_change_config()" id="cycle" value="10 20 20 60 300 3600" size="60"></input>
        </div>

        <div>
            Snapshot interval in milliseconds (0-1000):
            <input onchange="on_change_config()" id="diff_interval_in_milliseconds_input" type="number" value="200"
                min="1" max="1000" size="4"></input>
        </div>
        <div>
            Pixel threshold - how different must a pixel (r + g + b values) be to be considered different from previous
            snapshot?
            (1-765):
            <input onchange="on_change_config()" id="rgb_threshold_input" type="number" value="75" min="1"
                max="765"></input>
        </div>

        <div>
            Image threshold - percent of image pixels that must be different from previous snapshot to be considered
            motion (1-99):
            <input onchange="on_change_config()" id="image_pct_threshold_input" type="number" value="15" min="1"
                max="99"></input>

        </div>

        <div>
            Width (100-1000) and Height (100-1000) of raw image in pixels:
            <input onchange="on_change_config()" id="width_input" type="number" value="400" min="100"
                max="1000"></input>
            <input onchange="on_change_config()" id="height_input" type="number" value="200" min="100"
                max="1000"></input>
        </div>


        <div>
            Downscale full image for pixel analysis by this factor. Bigger is slower. (.1 to 1.0):
            <input onchange="on_change_config()" id="downscale_factor_input" type="number" value=".25" min=".1"
                max="1.0"></input>
        </div>

    </div>
    <div>
        Live Video:
        <br>
        <video id="video_el"></video>

    </div>

    <div>
        Motion <span id="score_el">0%</span>
        <br>
        <canvas id="live_motion_canvas"></canvas>
    </div>

    <div>
        Snapshot of motion
        <br>
        <canvas id="best_canvas"></canvas>
    </div>
</body>

</html>